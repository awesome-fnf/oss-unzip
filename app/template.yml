ROSTemplateFormatVersion: '2015-09-01'
Transform: 'Aliyun::Serverless-2018-04-03'
Parameters:
  SrcBucket:
    Type: String
    Description: Specifies the bucket where the compressed files are uploaded
  OSSKeyPrefix:
    Type: String
    Description: The object whose key begins with this prefix will be decompressed
    Default: ''
  OSSKeySuffix:
    Type: String
    Description: The object whose key ends with this suffix will be decompressed
    Default: .zip
  DestBucket:
    Type: String
    Description: >-
      The bucket that will be used to store the uncompressed files, and can be
      the same as the source bucket
  ProcessedDir:
    Type: String
    Description: Specifies the directory where the uncompressed files are stored
    Default: unzip
  MaxConcurrent:
    Type: Number
    Description: The max foreach concurrent
    Default: 100
  MaxWorkersPerTask:
    Type: Number
    Description: The max workers thread per unzip task
    Default: 100
  MinCountPerTask:
    Type: Number
    Description: The min number files unzip per task
    Default: 1000
Resources:
  UnzipSingleFileFlow:
    Type: 'Aliyun::Serverless::Flow'
    DependsOn:
      - OssUnzipFileServiceSplit
      - OssUnzipFileServiceUnzip
    Properties:
      Description: Unzip single file
      Policies:
        - AliyunFCInvocationAccess
      Definition:
        'Fn::Sub': |
          version: v1beta1
          type: flow
          steps:
            - type: pass
              name: init
              outputMappings:
                - target: src_bucket
                  source: $input.src_bucket
                - target: dest_bucket
                  source: $input.dest_bucket
                - target: key
                  source: $input.key
                - target: event_name
                  source: $input.event_name
                - target: max_concurrent
                  source: $input.max_concurrent
                - target: min_count_per_task
                  source: $input.min_count_per_task
                - target: max_workers_per_task
                  source: $input.max_workers_per_task
            - type: task
              name: split
              resourceArn: '${OssUnzipFileServiceSplit.ARN}'
              retry:
                - errors:
                    - FC.ResourceThrottled
                    - FC.ResourceExhausted
                    - FC.InternalServerError
                    - FC.Unknown
                    - FnF.TaskTimeout
                  intervalSeconds: 1
                  maxAttempts: 10
                  multiplier: 1.5
                  maxIntervalSeconds: 10
            - type: foreach
              name: unzipForeach
              iterationMapping:
                collection: $.groups
                item: group
              steps:
                - type: task
                  name: unzipTask
                  resourceArn: '${OssUnzipFileServiceUnzip.ARN}'
                  retry:
                    - errors:
                        - FC.ResourceThrottled
                        - FC.ResourceExhausted
                        - FC.InternalServerError
                        - FC.Unknown
                        - FnF.TaskTimeout
                      intervalSeconds: 1
                      maxAttempts: 10
                      multiplier: 1.5
                      maxIntervalSeconds: 10
                - type: choice
                  name: hasMoreFiles
                  choices:
                    - condition: $.status != "success"
                      goto: unzipTask
  OssUnzipFileService:
    Type: 'Aliyun::Serverless::Service'
    Properties:
      Policies:
        - Version: '1'
          Statement:
            - Effect: Allow
              Action:
                - 'oss:ListObjects'
                - 'oss:GetObject'
                - 'oss:PutObject'
              Resource: '*'
    ListZipFiles:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        Handler: index.handler
        Runtime: python3
        Timeout: 60
        MemorySize: 256
        CodeUri: >-
          oss://%bucket%/%templateName%/9d2ad12b00c262d13a147b4a192d0e05
    Split:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        Handler: index.handler
        Runtime: python3
        Timeout: 600
        MemorySize: 3072
        CodeUri: >-
          oss://%bucket%/%templateName%/35a5607d5d3909f8933c0643641409a2
    Unzip:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        Handler: unzip.handler
        Runtime: python3
        Timeout: 600
        MemorySize: 3072
        CodeUri: >-
          oss://%bucket%/%templateName%/35a5607d5d3909f8933c0643641409a2
        EnvironmentVariables:
          PROCESSED_DIR:
            Ref: ProcessedDir
          TIME_THRESHOLD: 500
  OssFileWatcher:
    Type: 'Aliyun::Serverless::Service'
    DependsOn:
      - UnzipSingleFileFlow
    Properties:
      Policies:
        - Version: '1'
          Statement:
            - Effect: Allow
              Action:
                - 'fnf:StartExecution'
              Resource: '*'
    StartUnzip:
      Type: 'Aliyun::Serverless::Function'
      Properties:
        Handler: index.handler
        Runtime: python3
        Timeout: 10
        MemorySize: 128
        CodeUri: >-
          oss://%bucket%/%templateName%/8454724e0d52b7bd48a71845ddc6892d
        EnvironmentVariables:
          DEST_BUCKET:
            Ref: DestBucket
          FLOW_NAME:
            'Fn::GetAtt':
              - UnzipSingleFileFlow
              - Name
          MAX_CONCURRENT:
            Ref: MaxConcurrent
          MAX_WORKERS_PER_TASK:
            Ref: MaxWorkersPerTask
          MIN_COUNT_PER_TASK:
            Ref: MinCountPerTask
      Events:
        onObjectCreated:
          Type: OSS
          Properties:
            BucketName:
              Ref: SrcBucket
            Events:
              - 'oss:ObjectCreated:PutObject'
              - 'oss:ObjectCreated:PostObject'
              - 'oss:ObjectCreated:CompleteMultipartUpload'
              - 'oss:ObjectCreated:PutSymlink'
            Filter:
              Key:
                Prefix:
                  Ref: OSSKeyPrefix
                Suffix:
                  Ref: OSSKeySuffix
