# This flow unzips one object from src_bucket to dest_bucket

# Input:
# {
#   "src_bucket": "a",
#   "dest_bucket": "b",
#   "key": "c.zip",
#   "event_name": "ObjectCreated:PutObject"
# }

# FDL reference: https://help.aliyun.com/document_detail/122492.html
# More examples: http://fnf.byexamples.org
version: v1beta1
type: flow
steps:
  - type: pass
    name: init
    outputMappings:
      - target: src_bucket
        source: $input.src_bucket
      - target: dest_bucket
        source: $input.dest_bucket
      - target: key
        source: $input.key
      - target: event_name
        source: $input.event_name
      - target: max_concurrent
        source: $input.max_concurrent
      - target: min_count_per_task
        source: $input.min_count_per_task
      - target: max_workers_per_task
        source: $input.max_workers_per_task

  # split files to groups
  - type: task
    name: split
    resourceArn: !Ref OssUnzipFileService/Split
    retry:
      - errors:
          - FC.ResourceThrottled
          - FC.ResourceExhausted
          - FC.InternalServerError
          - FC.Unknown
          - FnF.TaskTimeout
        intervalSeconds: 1
        maxAttempts: 10
        multiplier: 1.5
        maxIntervalSeconds: 10

  # foreach task to unzip each group
  - type: foreach
    name: unzipForeach
    iterationMapping:
      collection: $.groups
      item: group
    steps:
      - type: task
        name: unzipTask
        resourceArn: !Ref OssUnzipFileService/Unzip
        retry:
          - errors:
              - FC.ResourceThrottled
              - FC.ResourceExhausted
              - FC.InternalServerError
              - FC.Unknown
              - FnF.TaskTimeout
            intervalSeconds: 1
            maxAttempts: 10
            multiplier: 1.5
            maxIntervalSeconds: 10
      - type: choice
        name: hasMoreFiles
        choices:
          - condition: $.status != "success"
            goto: unzipTask
