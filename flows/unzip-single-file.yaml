# This flow unzips one object from src_bucket to dest_bucket

# Input:
# {
#   "src_bucket": "a",
#   "dest_bucket": "b",
#   "key": "c.zip"
# }

# FDL reference: https://help.aliyun.com/document_detail/122492.html
# More examples: http://fnf.byexamples.org
version: v1beta1
type: flow
steps:
  - type: pass
    name: init
    outputMappings:
      - target: marker
        source: ""
  - type: task
    name: unzip
    resourceArn: !Ref ossUnzip/unzip
    inputMappings:
      - target: src_bucket
        source: $input.src_bucket
      - target: dest_bucket
        source: $input.dest_bucket
      - target: key
        source: $input.key
      - target: marker
        source: $local.marker
    # 错误重试，可以定义多个重试策略，按照定义先后顺序匹配。
    retry:
      - errors:
        # 可恢复错误可以多重试几次
        - FC.ResourceThrottled
        - FC.ResourceExhausted
        - FC.InternalServerError
        - FC.Unknown
        - FnF.TaskTimeout
        intervalSeconds: 3
        maxAttempts: 10
        multiplier: 1.5
  - type: choice
    name: hasMoreFiles
    choices:
      - condition: $.marker != ""
        goto: unzip
